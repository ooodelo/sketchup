<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Point Cloud Manager</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #1f1f1f;
      color: #f5f5f5;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .toolbar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 12px;
      gap: 8px;
    }

    .toolbar label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #dddddd;
    }

    .toolbar input[type="checkbox"] {
      accent-color: #ff9800;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px;
      text-align: left;
    }

    tr.active {
      background-color: rgba(255, 166, 0, 0.2);
    }

    button {
      padding: 6px 10px;
      margin-right: 4px;
      background-color: #ff9800;
      color: #1f1f1f;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    button.secondary {
      background-color: #424242;
      color: #fafafa;
    }

    input[type="range"] {
      width: 120px;
    }

    .meta {
      font-size: 12px;
      color: #aaaaaa;
    }
  </style>
</head>
<body>
  <h1>Импортированные облака</h1>
  <div class="toolbar">
    <label>
      <input type="checkbox" id="auto-apply" checked />
      Auto-apply changes
    </label>
    <button id="apply-button">Применить</button>
  </div>
  <table id="cloud-table">
    <thead>
      <tr>
        <th>Имя</th>
        <th>Точек</th>
        <th>Плотность</th>
        <th>Размер точки</th>
        <th>Привязка</th>
        <th>Октодерево</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function throttle(fn, interval) {
      let lastTime = 0;
      let timeoutId = null;
      let pendingArgs = null;

      return (...args) => {
        const now = Date.now();
        const remaining = interval - (now - lastTime);
        pendingArgs = args;

        if (remaining <= 0) {
          if (timeoutId) {
            clearTimeout(timeoutId);
            timeoutId = null;
          }
          lastTime = now;
          fn(...pendingArgs);
          pendingArgs = null;
        } else if (!timeoutId) {
          timeoutId = setTimeout(() => {
            lastTime = Date.now();
            timeoutId = null;
            fn(...pendingArgs);
            pendingArgs = null;
          }, remaining);
        }
      };
    }

    let currentPayload = { clouds: [], auto_apply: true };
    let autoApplyEnabled = true;

    function setAutoApplyEnabled(enabled) {
      autoApplyEnabled = !!enabled;
      const checkbox = document.getElementById('auto-apply');
      if (checkbox) {
        checkbox.checked = autoApplyEnabled;
      }
      const applyButton = document.getElementById('apply-button');
      if (applyButton) {
        applyButton.disabled = autoApplyEnabled;
      }
    }

    function isValidIndex(index) {
      return Number.isInteger(index) && index >= 0 && index < currentPayload.clouds.length;
    }

    function logInvalidIndex(index, source) {
      console.warn(`[PointCloudImporter] Ignored ${source} request with invalid index:`, index);
    }

    function formatStats(stats) {
      if (!stats) {
        return '';
      }

      const visited = Number.isFinite(stats.nodes_visited) ? stats.nodes_visited : 0;
      const culled = Number.isFinite(stats.nodes_culled) ? stats.nodes_culled : 0;
      const points = Number.isFinite(stats.points_returned) ? stats.points_returned : 0;

      if (visited === 0 && culled === 0 && points === 0) {
        return '';
      }

      return `Узлов: ${visited}, отсечено: ${culled}, точек: ${points}`;
    }

    window.pci = {
      update(payload) {
        currentPayload = payload;
        const shouldAutoApply = payload.auto_apply !== false;
        setAutoApplyEnabled(shouldAutoApply);
        const tbody = document.querySelector('#cloud-table tbody');
        tbody.innerHTML = '';
        payload.clouds.forEach((cloud, index) => {
          const row = document.createElement('tr');
          if (cloud.active) {
            row.classList.add('active');
          }
          row.innerHTML = `
            <td>
              <div>${cloud.name}</div>
              <div class="meta">${cloud.metadata.comments ? cloud.metadata.comments.join('<br>') : ''}</div>
            </td>
            <td>${cloud.points.toLocaleString('ru-RU')}</td>
            <td>
              <input type="range" min="0.05" max="1" step="0.05" value="${cloud.density}" data-index="${index}" class="density" />
              <div class="meta">${(cloud.density * 100).toFixed(0)}%</div>
            </td>
            <td>
              <input type="range" min="1" max="10" step="1" value="${cloud.point_size}" data-index="${index}" class="point-size" />
            </td>
            <td>
              <button class="inference" data-index="${index}">${cloud.inference ? 'Выключить' : 'Включить'}</button>
              <div class="meta">${cloud.inference ? 'Созданы направляющие точки' : 'Нет направляющих'}</div>
            </td>
            <td>
              <label>
                <input type="checkbox" class="octree-debug" data-index="${index}" ${cloud.octree_debug ? 'checked' : ''} />
                <span class="meta">Показать границы</span>
              </label>
              <div class="meta">${formatStats(cloud.octree_stats)}</div>
            </td>
            <td>
              <button class="toggle" data-index="${index}">${cloud.visible ? 'Скрыть' : 'Показать'}</button>
              <button class="activate secondary" data-index="${index}">Активировать</button>
              <button class="remove secondary" data-index="${index}">Удалить</button>
            </td>
          `;
          tbody.appendChild(row);
        });
        wireEvents();
      }
    };

    function wireEvents() {
      document.querySelectorAll('button.toggle').forEach(button => {
        button.addEventListener('click', () => {
          const index = Number.parseInt(button.dataset.index, 10);
          if (!isValidIndex(index)) {
            logInvalidIndex(button.dataset.index, 'visibility toggle');
            return;
          }
          window.sketchup && window.sketchup.pci_toggle_visibility(index);
        });
      });

      document.querySelectorAll('button.activate').forEach(button => {
        button.addEventListener('click', () => {
          const index = Number.parseInt(button.dataset.index, 10);
          if (!isValidIndex(index)) {
            logInvalidIndex(button.dataset.index, 'activate');
            return;
          }
          window.sketchup && window.sketchup.pci_activate(index);
        });
      });

      document.querySelectorAll('button.remove').forEach(button => {
        button.addEventListener('click', () => {
          const index = Number.parseInt(button.dataset.index, 10);
          if (!isValidIndex(index)) {
            logInvalidIndex(button.dataset.index, 'remove');
            return;
          }
          if (confirm('Удалить облако?')) {
            window.sketchup && window.sketchup.pci_remove(index);
          }
        });
      });

      document.querySelectorAll('input.octree-debug').forEach(input => {
        input.addEventListener('change', () => {
          const index = Number.parseInt(input.dataset.index, 10);
          if (!isValidIndex(index)) {
            logInvalidIndex(input.dataset.index, 'octree debug');
            return;
          }
          const value = input.checked;
          window.sketchup && window.sketchup.pci_toggle_octree_debug(index, value);
        });
      });

      document.querySelectorAll('input.density').forEach(input => {
        const throttledPreview = throttle((index, value) => {
          if (!isValidIndex(index)) {
            logInvalidIndex(index, 'density preview');
            return;
          }
          window.sketchup && window.sketchup.pci_preview_density(index, value);
        }, 100);
        const meta = input.parentElement.querySelector('.meta');

        input.addEventListener('input', () => {
          const value = input.value;
          if (meta) {
            const numeric = Number.parseFloat(value);
            meta.textContent = Number.isFinite(numeric) ? `${(numeric * 100).toFixed(0)}%` : meta.textContent;
          }
          const index = Number.parseInt(input.dataset.index, 10);
          if (!isValidIndex(index)) {
            logInvalidIndex(input.dataset.index, 'density');
            return;
          }
          throttledPreview(index, value);
        });

        input.addEventListener('change', () => {
          const index = Number.parseInt(input.dataset.index, 10);
          if (!isValidIndex(index)) {
            logInvalidIndex(input.dataset.index, 'density');
            return;
          }
          window.sketchup && window.sketchup.pci_density(index, input.value);
        });
      });

      document.querySelectorAll('input.point-size').forEach(input => {
        const throttledPreview = throttle((index, value) => {
          if (!isValidIndex(index)) {
            logInvalidIndex(index, 'point size preview');
            return;
          }
          window.sketchup && window.sketchup.pci_preview_point_size(index, value);
        }, 100);
        input.addEventListener('input', () => {
          const index = Number.parseInt(input.dataset.index, 10);
          if (!isValidIndex(index)) {
            logInvalidIndex(input.dataset.index, 'point size');
            return;
          }
          throttledPreview(index, input.value);
        });

        input.addEventListener('change', () => {
          const index = Number.parseInt(input.dataset.index, 10);
          if (!isValidIndex(index)) {
            logInvalidIndex(input.dataset.index, 'point size');
            return;
          }
          window.sketchup && window.sketchup.pci_point_size(index, input.value);
        });
      });

      document.querySelectorAll('button.inference').forEach(button => {
        button.addEventListener('click', () => {
          const index = Number.parseInt(button.dataset.index, 10);
          if (!isValidIndex(index)) {
            logInvalidIndex(button.dataset.index, 'inference toggle');
            return;
          }
          window.sketchup && window.sketchup.pci_toggle_inference(index);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.sketchup && window.sketchup.pci_ready();

      const autoApplyToggle = document.getElementById('auto-apply');
      if (autoApplyToggle) {
        autoApplyToggle.addEventListener('change', () => {
          const enabled = autoApplyToggle.checked;
          setAutoApplyEnabled(enabled);
          window.sketchup && window.sketchup.pci_set_auto_apply(enabled);
        });
      }

      const applyButton = document.getElementById('apply-button');
      if (applyButton) {
        applyButton.addEventListener('click', () => {
          if (applyButton.disabled) {
            return;
          }
          window.sketchup && window.sketchup.pci_apply_preferences();
        });
      }

      setAutoApplyEnabled(autoApplyEnabled);
    });
  </script>
</body>
</html>
