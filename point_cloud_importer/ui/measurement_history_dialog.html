<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Measurement History</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #1f1f1f;
      color: #f5f5f5;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .toolbar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px;
      text-align: left;
      font-size: 13px;
    }

    th {
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 12px;
      color: #bdbdbd;
    }

    tr.preview {
      background-color: rgba(0, 150, 255, 0.15);
    }

    button {
      padding: 6px 10px;
      margin-right: 6px;
      background-color: #ff9800;
      color: #1f1f1f;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }

    button.secondary {
      background-color: #424242;
      color: #fafafa;
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .empty {
      margin-top: 24px;
      font-size: 14px;
      color: #b0b0b0;
      text-align: center;
    }

    .points {
      font-size: 12px;
      color: #bdbdbd;
    }
  </style>
</head>
<body>
  <h1>История измерений</h1>
  <div class="toolbar">
    <button id="export">Export CSV</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Время</th>
        <th>Расстояние</th>
        <th>Точки</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody id="history-rows"></tbody>
  </table>
  <div id="empty" class="empty" hidden>Пока нет измерений.</div>

  <script>
    (function() {
      const state = {
        entries: [],
        previewIndex: null
      };

      function update(payload) {
        state.entries = Array.isArray(payload.entries) ? payload.entries : [];
        const preview = payload.preview_index;
        state.previewIndex = Number.isInteger(preview) ? preview : null;
        render();
      }

      function render() {
        const tbody = document.getElementById('history-rows');
        const empty = document.getElementById('empty');
        tbody.innerHTML = '';

        if (!state.entries.length) {
          empty.hidden = false;
          return;
        }

        empty.hidden = true;

        state.entries.forEach((entry) => {
          const row = document.createElement('tr');
          if (entry.index === state.previewIndex) {
            row.classList.add('preview');
          }

          const timeCell = document.createElement('td');
          timeCell.textContent = entry.formatted_time || entry.timestamp;

          const distanceCell = document.createElement('td');
          distanceCell.textContent = entry.label || '';

          const pointsCell = document.createElement('td');
          pointsCell.innerHTML = `
            <div class="points">От: ${formatPoint(entry.from)}</div>
            <div class="points">До: ${formatPoint(entry.to)}</div>
          `;

          const actionsCell = document.createElement('td');
          const showButton = document.createElement('button');
          const isPreview = entry.index === state.previewIndex;
          showButton.textContent = isPreview ? 'Скрыть' : 'Показать';
          showButton.addEventListener('click', () => {
            window.sketchup && window.sketchup.pci_history_preview(entry.index);
          });

          const copyButton = document.createElement('button');
          copyButton.classList.add('secondary');
          copyButton.textContent = 'Копировать';
          copyButton.addEventListener('click', () => {
            window.sketchup && window.sketchup.pci_history_copy(entry.index);
          });

          const deleteButton = document.createElement('button');
          deleteButton.classList.add('secondary');
          deleteButton.textContent = 'Удалить';
          deleteButton.addEventListener('click', () => {
            window.sketchup && window.sketchup.pci_history_delete(entry.index);
          });

          const dimensionButton = document.createElement('button');
          dimensionButton.classList.add('secondary');
          dimensionButton.textContent = 'Создать размер';
          dimensionButton.addEventListener('click', () => {
            window.sketchup && window.sketchup.pci_history_dimension(entry.index);
          });

          actionsCell.appendChild(showButton);
          actionsCell.appendChild(copyButton);
          actionsCell.appendChild(deleteButton);
          actionsCell.appendChild(dimensionButton);

          row.appendChild(timeCell);
          row.appendChild(distanceCell);
          row.appendChild(pointsCell);
          row.appendChild(actionsCell);
          tbody.appendChild(row);
        });
      }

      function formatPoint(point) {
        if (!Array.isArray(point) || point.length < 3) {
          return '';
        }
        return `(${point.map((value) => Number(value).toFixed(3)).join(', ')})`;
      }

      window.pciHistory = { update };

      document.addEventListener('DOMContentLoaded', () => {
        const exportButton = document.getElementById('export');
        exportButton.addEventListener('click', () => {
          window.sketchup && window.sketchup.pci_history_export();
        });
        window.sketchup && window.sketchup.pci_history_ready();
      });
    })();
  </script>
</body>
</html>
