# Point Cloud Importer for SketchUp Pro 2023

Плагин добавляет в SketchUp Pro 2023 (macOS) полноценную работу с облаками точек:

- Импорт ASCII и бинарных PLY файлов с миллионами точек.
- Визуализация через аппаратно-ускоренный overlay без создания тяжелой геометрии.
- Управление облаками через отдельный менеджер: видимость, активность, плотность отображения, размер точек и направляющие для привязки.
- Интерактивный инструмент измерения расстояний между точками с выводом длины в привычных единицах SketchUp.
- Панель инструментов и команды меню Extensions → Point Cloud Importer.

## Основные возможности

### Импорт
1. Запустите команду **Extensions → Point Cloud Importer → Импорт облака точек...**.
2. Выберите PLY файл. Поддерживаются ASCII и binary little endian форматы с цветами (RGB) или без них.
3. В диалоге настройте размер и стиль точек, долю отображаемых точек в окне и ограничение по количеству точек на экран.
4. После импорта облако появится как новый слой визуализации и станет активным.

### Менеджер облаков
- Команда **Менеджер облаков...** открывает HtmlDialog с перечнем загруженных облаков.
- Слайдер плотности позволяет плавно снижать нагрузку (от 5% до 100% точек).
- Слайдер размера точек меняет визуальную толщину маркеров.
- Кнопки «Скрыть/Показать», «Активировать» и «Удалить» управляют облаком напрямую.
- Кнопка «Включить/Выключить» в колонке «Привязка» создаёт/удаляет вспомогательные направляющие (Construction Points) для снапа нативными инструментами.

### Измерения
- Команда **Измерить расстояние в облаке** активирует инструмент.
- Кликните по двум точкам облака — появится линия и диалог с длиной в системных единицах модели.

### Прочие особенности
- Отрисовка выполняется через SketchUp Model Overlay, поэтому не перегружает модель миллионами объектов.
- Для привязки стандартных инструментов можно включить направляющие Construction Points (оптимизированная выборка до 50 тыс. точек) — они скрываются вместе с облаком.
- Для поиска точки используется адаптивное KD-дерево с пониженной выборкой, что позволяет быстро находить ближайшие точки даже в облаках 5–8 млн вершин.
- Предпочтения (размер, стиль точек, лимиты отображения) сохраняются в настройках SketchUp.
- При импорте каждое облако раскладывается в октодерево с ограничением до 100 000 точек на узел. В процессе отрисовки выполняется frustum culling и в GPU отправляются только те листья, которые попадают в пирамиду видимости камеры. В типовой сцене это сокращает количество рисуемых точек в 5–10 раз и держит FPS стабильным даже при миллионах вершин. Для динамических облаков перестраиваются только затронутые узлы октодерева, поэтому обновление занимает доли секунды.

## Установка
1. Скачайте или склонируйте репозиторий.
2. Поместите папку `point_cloud_importer` и файл `point_cloud_importer.rb` в каталог плагинов SketchUp (`~/Library/Application Support/SketchUp 2023/SketchUp/Plugins`).
3. Перезапустите SketchUp. В меню Extensions появится раздел **Point Cloud Importer** и соответствующая панель инструментов.

## Структура файлов плагина
- `point_cloud_importer.rb` — регистрация расширения в SketchUp и подключение основного кода.
- `point_cloud_importer/extension.rb` — описание SketchUp::Extension, точка входа при загрузке.
- `point_cloud_importer/importer.rb` — импорт PLY, потоковое чтение и создание облака точек.
- `point_cloud_importer/point_cloud.rb` — представление облака: хранение точек, материал, фильтрация, включение/выключение.
- `point_cloud_importer/viewer_overlay.rb` — отрисовка точек через Overlay API без геометрии SketchUp.
- `point_cloud_importer/manager.rb` — менеджер облаков: список активных облаков, операции скрытия, удаления, переключения.
- `point_cloud_importer/measure_tool.rb` — инструмент измерения расстояний по облаку, работа с KD-деревом.
- `point_cloud_importer/spatial_index.rb` — реализация KD-дерева для быстрого поиска ближайших точек.
- `point_cloud_importer/ply_parser.rb` — парсер PLY (ASCII и binary little endian) с поддержкой цветов.
- `point_cloud_importer/settings.rb` — хранение и загрузка пользовательских настроек визуализации.
- `point_cloud_importer/ui/commands.rb` — регистрация команд меню и панели инструментов.
- `point_cloud_importer/ui/manager_dialog.rb` — HtmlDialog контроллер, синхронизация UI и Ruby.
- `point_cloud_importer/ui/manager_dialog.html` — интерфейс менеджера облаков на HTML/JS/CSS.

## Алгоритм работы плагина
1. **Загрузка расширения.** При запуске SketchUp файл `point_cloud_importer.rb` регистрирует расширение и подключает модуль `PointCloudImporter`. Активатор из `extension.rb` инициализирует менеджер облаков, читает сохранённые настройки и регистрирует команды/панель инструментов через глобальный `::UI`.
2. **Импорт PLY.** Когда пользователь выбирает команду импорта, `importer.rb` открывает диалог выбора файла, а затем потоково читает PLY через `ply_parser.rb`. Данные читаются порциями, конвертируются в метрические координаты SketchUp и сразу пересылаются в объект `PointCloud`, не создавая тяжёлую геометрию.
3. **Создание облака.** `PointCloud` формирует лёгкую структуру хранения: массив точек, метаданные и материалы. Параллельно строится KD-дерево (`spatial_index.rb`) с пониженной выборкой для быстрых запросов ближайших точек, а также генерируется кеш направляющих (construction points) для опционального снапа.
4. **Отрисовка.** Для отображения используется `viewer_overlay.rb`, который регистрирует overlay-обработчик SketchUp. Обработчик получает активные облака из `manager.rb`, фильтрует точки по текущей плотности/лимитам и рисует их с помощью `view.draw_points`, подбирая поддерживаемый стиль и размер.
5. **Управление и UX.** `manager.rb` поддерживает список облаков, реагирует на команды меню и события HtmlDialog (`manager_dialog.rb/html`). Через него выполняются операции скрытия, удаления, изменения плотности/размера точек, активации облака и переключения направляющих для снапа.
6. **Измерения.** Инструмент `measure_tool.rb` при активации запрашивает ближайшие к курсору точки у менеджера. KD-дерево возвращает координаты, после чего инструмент строит временную линию и показывает расстояние в статус-баре/диалоге SketchUp. Результаты измерений не создают постоянную геометрию.
7. **Сохранение состояния.** При изменении настроек `settings.rb` обновляет соответствующие значения через API `Sketchup.write_default`, чтобы при следующем запуске восстановить размер, стиль и плотность точек. Менеджер закрывает диалоги и освобождает ресурсы при выгрузке расширения.

## UX и пользовательский сценарий
- **Точка входа.** Все функции сосредоточены в разделе **Extensions → Point Cloud Importer** и одноимённой панели инструментов. При первой загрузке панель появляется автоматически и содержит три кнопки: импорт, менеджер облаков и измерение.
- **Импорт как отдельный поток.** Команда импорта открывает модальное окно SketchUp выбора файла, после чего отображает статус в строке состояния («Чтение PLY…», «Построение индекса…»). Пока идёт загрузка, остальные кнопки панелей остаются активными, но операции с облаками блокируются, чтобы пользователь не нарушил процесс.
- **Контекстный менеджер.** После импорта автоматически открывается HtmlDialog менеджера. В нём перечень облаков отображается таблицей: слева миниатюра/цвет, справа — переключатели видимости, привязки и активного облака. Контролы расположены в порядке «импорт → настройка → измерение»: сверху глобальные действия (добавить, скрыть все, удалить), ниже — карточки облаков с слайдерами и переключателями.
- **Минимальные клики.** Каждая карточка содержит самые частые действия в одну строку: чекбокс видимости, переключатель привязки, кнопка «Сделать активным». Слайдеры плотности и размера точек по умолчанию скрыты в аккордеоне «Дополнительно», чтобы не перегружать экран. При наведении курсора показывается всплывающая подсказка с текущим значением.
- **Интеграция со статус-баром.** Любое изменение параметров облака сопровождается кратким сообщением в статус-баре («Плотность облака снижена до 40%», «Направляющие включены»), чтобы пользователь понимал результат без открытия диалога.
- **Измерения с подтверждением.** При запуске инструмента измерения статус-бар объясняет, что делать («Выберите первую точку облака»). После выбора двух точек появляется временная линия и HtmlDialog с результатом. Там же кнопка «Скопировать значение» и история последних пяти измерений.
- **Управление видимостью.** Помимо команд меню, в панели инструментов находится кнопка «Скрыть/показать активное облако», которая мгновенно меняет его состояние. Диалог менеджера синхронизируется через наблюдателей и показывает актуальные флаги.
- **Сохранение предпочтений.** При закрытии менеджера выбранные параметры (размер точек, плотность по умолчанию, наличие направляющих) записываются в настройки и восстанавливаются при следующем запуске, чтобы пользователь не выполнял повторную настройку.

## Требования
- SketchUp Pro 2023 или новее.
- macOS.
- Объем оперативной памяти, достаточный для выбранного облака точек.

## Ограничения и рекомендации
- Для файлов с более чем 8 млн точек используйте ограничение по отображаемому количеству и плотности, чтобы удерживать отзывчивость viewport.
- Инструмент измерения проецирует позицию курсора на плоскость, проходящую через центр облака. Для сложных сцен рекомендуется приближать вид к нужной области перед измерением.
- Если исходный PLY содержит дополнительные свойства (например, интенсивность), они сохраняются в метаданных и отображаются в менеджере облаков.

## План развития
- Поддержка других форматов (E57, LAS/LAZ).
- Экспорт выбранных точек в отдельный файл.
- Расширенные фильтры: обрезка по диапазону высот и создание сечений.
